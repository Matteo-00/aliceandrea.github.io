<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conferme Matrimonio - Admin</title>

  <!-- Font eleganti -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="conferme.css">
</head>

<body>

  <div class="admin-container">
    <header class="admin-header">
      <h1 class="admin-title">Conferme Matrimonio</h1>
      <p class="admin-subtitle">Alice & Andrea - Gestione partecipazioni</p>
      <a href="index.html" class="btn-back">‚Üê Torna al sito</a>
    </header>

    <!-- Filtri e ricerca -->
    <div class="filters-section">
      <div class="search-bar">
        <input type="text" id="searchAll" placeholder="üîç Ricerca generale..." class="search-input">
      </div>

      <div class="filters-grid">
        <div class="filter-group">
          <label>Cerca per nome</label>
          <input type="text" id="filterNome" placeholder="Nome..." class="filter-input">
        </div>

        <div class="filter-group">
          <label>Cerca per cognome</label>
          <input type="text" id="filterCognome" placeholder="Cognome..." class="filter-input">
        </div>

        <div class="filter-group">
          <label>Presenza</label>
          <select id="filterPresenza" class="filter-select">
            <option value="">Tutti</option>
            <option value="true">Partecipano</option>
            <option value="false">Non partecipano</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Allergie</label>
          <select id="filterAllergie" class="filter-select">
            <option value="">Tutti</option>
            <option value="true">S√¨</option>
            <option value="false">No</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Ordina per</label>
          <select id="sortBy" class="filter-select">
            <option value="data_desc">Data (pi√π recenti)</option>
            <option value="data_asc">Data (pi√π vecchi)</option>
            <option value="nome_asc">Nome (A-Z)</option>
            <option value="nome_desc">Nome (Z-A)</option>
            <option value="cognome_asc">Cognome (A-Z)</option>
            <option value="cognome_desc">Cognome (Z-A)</option>
          </select>
        </div>

        <div class="filter-group">
          <button id="resetFilters" class="btn-reset">Cancella filtri</button>
        </div>
      </div>
    </div>

    <!-- Statistiche -->
    <div class="stats-section">
      <div class="stat-card">
        <span class="stat-number" id="totalConferme">0</span>
        <span class="stat-label">Conferme totali</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalPresenti">0</span>
        <span class="stat-label">Partecipano</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalAssenti">0</span>
        <span class="stat-label">Non partecipano</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalPartecipanti">0</span>
        <span class="stat-label">Numero partecipanti</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalAllergie">0</span>
        <span class="stat-label">Con allergie</span>
      </div>
    </div>

    <!-- Tabella -->
    <div class="table-container">
      <div id="loadingMessage" class="loading-message">Caricamento dati...</div>
      <div id="errorMessage" class="error-message" style="display: none;"></div>
      
      <table class="conferme-table" id="confermeTable" style="display: none;">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Cognome</th>
            <th>Presenza</th>
            <th>N. Partecipanti</th>
            <th>Note Partecipanti</th>
            <th>Messaggio</th>
            <th>Allergie</th>
            <th>Dettagli Allergie</th>
            <th>Data Conferma</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Rows dinamiche -->
        </tbody>
      </table>

      <div id="noResults" class="no-results" style="display: none;">
        Nessun risultato trovato
      </div>
    </div>

  </div>

  <script>
    const SUPABASE_URL = 'https://wdinlazhjttgrkxdzyoa.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkaW5sYXpoanR0Z3JreGR6eW9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MTEwNTgsImV4cCI6MjA4NzA4NzA1OH0.C9AIZLk_mYVxGh4Po0OPyr_RcQtkplytCjyRLRB-IM4';

    let allData = [];
    let filteredData = [];

    // Elementi DOM
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const confermeTable = document.getElementById('confermeTable');
    const tableBody = document.getElementById('tableBody');
    const noResults = document.getElementById('noResults');

    // Filtri
    const searchAll = document.getElementById('searchAll');
    const filterNome = document.getElementById('filterNome');
    const filterCognome = document.getElementById('filterCognome');
    const filterPresenza = document.getElementById('filterPresenza');
    const filterAllergie = document.getElementById('filterAllergie');
    const sortBy = document.getElementById('sortBy');
    const resetFilters = document.getElementById('resetFilters');

    // Stat cards
    const totalConferme = document.getElementById('totalConferme');
    const totalPresenti = document.getElementById('totalPresenti');
    const totalAssenti = document.getElementById('totalAssenti');
    const totalPartecipanti = document.getElementById('totalPartecipanti');
    const totalAllergie = document.getElementById('totalAllergie');

    // Carica dati da Supabase
    async function loadData() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/adesioni_matrimonio?select=*`, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        if (!response.ok) {
          throw new Error('Errore nel caricamento dei dati');
        }

        allData = await response.json();
        filteredData = [...allData];
        
        loadingMessage.style.display = 'none';
        confermeTable.style.display = 'table';
        
        updateStats();
        applyFiltersAndSort();
        
      } catch (error) {
        console.error('Errore:', error);
        loadingMessage.style.display = 'none';
        errorMessage.textContent = 'Errore nel caricamento dei dati. Riprova.';
        errorMessage.style.display = 'block';
      }
    }

    // Aggiorna statistiche
    function updateStats() {
      const presenti = allData.filter(d => d.presenza === true);
      const assenti = allData.filter(d => d.presenza === false);
      const numPartecipanti = presenti.reduce((sum, d) => sum + (d.numero_partecipanti || 0), 0);
      const conAllergie = presenti.filter(d => d.allergeni_intolleranze === true).length;

      totalConferme.textContent = allData.length;
      totalPresenti.textContent = presenti.length;
      totalAssenti.textContent = assenti.length;
      totalPartecipanti.textContent = numPartecipanti;
      totalAllergie.textContent = conAllergie;
    }

    // Applica filtri e ordinamento
    function applyFiltersAndSort() {
      // Inizia con tutti i dati
      filteredData = [...allData];

      // Ricerca generale
      const searchTerm = searchAll.value.toLowerCase().trim();
      if (searchTerm) {
        filteredData = filteredData.filter(item => {
          return (
            (item.nome?.toLowerCase() || '').includes(searchTerm) ||
            (item.cognome?.toLowerCase() || '').includes(searchTerm) ||
            (item.descrizione_presenza?.toLowerCase() || '').includes(searchTerm) ||
            (item.descrizione_numero_partecipanti?.toLowerCase() || '').includes(searchTerm) ||
            (item.descrizione_allergeni_intolleranze?.toLowerCase() || '').includes(searchTerm)
          );
        });
      }

      // Filtro nome
      const nomeFilter = filterNome.value.toLowerCase().trim();
      if (nomeFilter) {
        filteredData = filteredData.filter(item => 
          (item.nome?.toLowerCase() || '').includes(nomeFilter)
        );
      }

      // Filtro cognome
      const cognomeFilter = filterCognome.value.toLowerCase().trim();
      if (cognomeFilter) {
        filteredData = filteredData.filter(item => 
          (item.cognome?.toLowerCase() || '').includes(cognomeFilter)
        );
      }

      // Filtro presenza
      if (filterPresenza.value !== '') {
        const presenzaValue = filterPresenza.value === 'true';
        filteredData = filteredData.filter(item => item.presenza === presenzaValue);
      }

      // Filtro allergie
      if (filterAllergie.value !== '') {
        const allergieValue = filterAllergie.value === 'true';
        filteredData = filteredData.filter(item => item.allergeni_intolleranze === allergieValue);
      }

      // Ordinamento
      const sortValue = sortBy.value;
      filteredData.sort((a, b) => {
        switch(sortValue) {
          case 'data_desc':
            return new Date(b.data_compilazione) - new Date(a.data_compilazione);
          case 'data_asc':
            return new Date(a.data_compilazione) - new Date(b.data_compilazione);
          case 'nome_asc':
            return (a.nome || '').localeCompare(b.nome || '');
          case 'nome_desc':
            return (b.nome || '').localeCompare(a.nome || '');
          case 'cognome_asc':
            return (a.cognome || '').localeCompare(b.cognome || '');
          case 'cognome_desc':
            return (b.cognome || '').localeCompare(a.cognome || '');
          default:
            return 0;
        }
      });

      renderTable();
    }

    // Renderizza tabella
    function renderTable() {
      if (filteredData.length === 0) {
        tableBody.innerHTML = '';
        confermeTable.style.display = 'none';
        noResults.style.display = 'block';
        return;
      }

      confermeTable.style.display = 'table';
      noResults.style.display = 'none';

      tableBody.innerHTML = filteredData.map(item => {
        const dataFormatted = new Date(item.data_compilazione).toLocaleString('it-IT', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        return `
          <tr class="${item.presenza ? 'presenza-si' : 'presenza-no'}">
            <td>${item.nome || '-'}</td>
            <td>${item.cognome || '-'}</td>
            <td>
              <span class="badge ${item.presenza ? 'badge-success' : 'badge-danger'}">
                ${item.presenza ? '‚úì S√¨' : '‚úó No'}
              </span>
            </td>
            <td class="text-center">${item.presenza ? (item.numero_partecipanti || '-') : '-'}</td>
            <td>${item.descrizione_numero_partecipanti || '-'}</td>
            <td>${item.descrizione_presenza || '-'}</td>
            <td class="text-center">
              ${item.presenza ? 
                `<span class="badge ${item.allergeni_intolleranze ? 'badge-warning' : 'badge-info'}">${item.allergeni_intolleranze ? 'S√¨' : 'No'}</span>` 
                : '-'}
            </td>
            <td>${item.descrizione_allergeni_intolleranze || '-'}</td>
            <td class="text-nowrap">${dataFormatted}</td>
          </tr>
        `;
      }).join('');
    }

    // Eventi filtri
    searchAll.addEventListener('input', applyFiltersAndSort);
    filterNome.addEventListener('input', applyFiltersAndSort);
    filterCognome.addEventListener('input', applyFiltersAndSort);
    filterPresenza.addEventListener('change', applyFiltersAndSort);
    filterAllergie.addEventListener('change', applyFiltersAndSort);
    sortBy.addEventListener('change', applyFiltersAndSort);

    resetFilters.addEventListener('click', () => {
      searchAll.value = '';
      filterNome.value = '';
      filterCognome.value = '';
      filterPresenza.value = '';
      filterAllergie.value = '';
      sortBy.value = 'data_desc';
      applyFiltersAndSort();
    });

    // Carica dati all'avvio
    loadData();

    // Ricarica ogni 30 secondi
    setInterval(loadData, 30000);
  </script>
</body>
</html>
